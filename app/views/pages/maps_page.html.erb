<!DOCTYPE html>
<html>
  <head>
    <title>Client Map</title>
    <style>
      #map {
        height: 90vh;
        width: 80%;
        margin: 10px auto;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      var samarkand;
      var infoWindow;

      function initMap() {
        infoWindow = new google.maps.InfoWindow();

        // Try HTML5 geolocation
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var currentLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            samarkand = new google.maps.Map(document.getElementById('map'), {
              center: currentLocation,
              zoom: 14,
              mapId: "7802c15fc3df6792",
            });

            // Add a marker for the current location
            var currentLocationMarker = new google.maps.Marker({
              position: currentLocation,
              map: samarkand,
              title: 'Your Current Location',
              icon: {
                url: '<%= asset_path("current_location.png") %>',
                scaledSize: new google.maps.Size(40, 40)
              }
            });

            // Add a click event listener to open info window for current location
            currentLocationMarker.addListener('click', function() {
              infoWindow.setContent('Your Current Location');
              infoWindow.open(samarkand, currentLocationMarker);
            });

            // Add markers for buyers
            <% @buyers.each do |buyer| %>
              var buyerMarker = new google.maps.Marker({
                position: {lat: <%= buyer.latitude %>, lng: <%= buyer.longitude %>},
                map: samarkand,
                title: '<%= buyer.name %>',
                mapId: "7802c15fc3df6792",
                icon: {
                  url: '<%= asset_path("location.png") %>',
                  scaledSize: new google.maps.Size(70, 70)
                }
              });
              buyerMarker.addListener('click', function() {
                window.open('<%= buyer_path(buyer.id) %>', '_blank');
              });
            <% end %>
          }, function() {
            handleLocationError(true, infoWindow, samarkand.getCenter());
          });
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, samarkand.getCenter());
        }
      }

      function handleLocationError(browserHasGeolocation, infoWindow, currentLocation) {
        infoWindow.setPosition(currentLocation);
        infoWindow.setContent(browserHasGeolocation ?
                              'Error: The Geolocation service failed.' :
                              'Error: Your browser doesn\'t support geolocation.');
        infoWindow.open(samarkand);
      }
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCCrf73WQ7VitOY7_PP0pSGmeBDw-Tiz38&libraries=places&callback&callback=initMap&map_ids=7802c15fc3df6792" async defer></script>
    <script src="https://cdn.rawgit.com/googlemaps/v3-utility-library/master/markerwithlabel/src/markerwithlabel.js"></script>
  </body>
</html>

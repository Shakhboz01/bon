  <head>
    <title>Client Map</title>
    <style>
      #map {
        height: 90vh;
        width: 80%;
        margin: 10px auto;
      }
      img {
        border-radius: 0 0 15px 15px;
      }
    </style>
  </head>
 <body>
    <div class='text-center'>
      <%= link_to 'Ko\'rinishni o\'zgartirish', main_page_url, class: 'btn btn-primary' %><hr>
    </div>
    <div id="map-container" style="position: relative;">
      <div class="input-group mb-3" style="position: absolute; top: 45px; left: 50%; transform: translateX(-50%); width: 130px;">
        <input id="search-box" type="text" class="form-control" placeholder="Поиск" aria-label="Поиск" aria-describedby="basic-addon2">
      </div>
    </div>
    <div id="map"></div>
    <script>
        // $(document).on('turbo:load', function(){
        // })
        var samarkand;
        var infoWindow;
        var searchBox;
        var markers = [];

        function initMap() {
            infoWindow = new google.maps.InfoWindow();

            // Try HTML5 geolocation
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    samarkand = new google.maps.Map(document.getElementById('map'), {
                        center: currentLocation,
                        zoom: 14,
                        mapId: "7802c15fc3df6792",
                    });

                    var currentLocationMarker = new google.maps.Marker({
                        position: currentLocation,
                        map: samarkand,
                        title: 'Your Current Location',
                        icon: {
                            url: '<%= asset_path("current_location.png") %>',
                            scaledSize: new google.maps.Size(40, 40)
                        }
                    });

                    currentLocationMarker.addListener('click', function () {
                        infoWindow.setContent('Your Current Location');
                        infoWindow.open(samarkand, currentLocationMarker);
                    });

                    // Create the search box and link it to the UI element
                    var input = document.getElementById("search-box");
                    searchBox = new google.maps.places.Autocomplete(input);
                    searchBox.bindTo('bounds', samarkand);

                    // Bias the SearchBox results towards current map's viewport
                    searchBox.addListener('place_changed', function () {
                        searchPlaces();
                    });

                    // Add markers for buyers
                    <% @buyers.each do |buyer| %>
                        var buyerMarkerIcon = '<%= asset_path("location.png") %>';

                        // If buyer has images, use the first one as marker icon
                        <% if buyer.images.attached? %>
                            buyerMarkerIcon = '<%= rails_blob_path(buyer.images.first) %>';
                        <% end %>

                        var buyerMarker = new google.maps.Marker({
                            position: { lat: <%= buyer.latitude %>, lng: <%= buyer.longitude %> },
                            map: samarkand,
                            // label: {
                            //     text: '<%= buyer.name %>',
                            //     color: 'green',
                            //     fontSize: '28px',
                            //     fontWeight: 'bold',
                            //     fontFamily: '"Courier New", Courier,Monospace',
                            //     zIndex: 2
                            // },
                            title: '<%= buyer.name %>',
                            mapId: "7802c15fc3df6792",
                            icon: {
                                url: buyerMarkerIcon,
                                scaledSize: new google.maps.Size(55, 60),
                                shape:{coords:[17,17,18],type:'circle'},
                                optimized:false
                            }
                        });
                        buyerMarker.addListener('click', function () {
                            window.open('<%= buyer_path(buyer.id) %>', '_blank');
                        });
                    <% end %>
                }, function () {
                    handleLocationError(true, infoWindow, samarkand.getCenter());
                });
            } else {
                // Browser doesn't support Geolocation
                handleLocationError(false, infoWindow, samarkand.getCenter());
            }
        }

        function searchPlaces() {
            var place = searchBox.getPlace();

            if (!place.geometry) {
                window.alert("No details available for input: '" + place.name + "'");
                return;
            }

            // Clear out the old markers
            markers.forEach(function (marker) {
                marker.setMap(null);
            });
            markers = [];

            // Create a marker for the selected place
            var marker = new google.maps.Marker({
                map: samarkand,
                position: place.geometry.location,
                title: place.name
            });

            markers.push(marker);

            // Center the map on the selected place
            samarkand.setCenter(place.geometry.location);
            samarkand.setZoom(16);
        }

        function handleLocationError(browserHasGeolocation, infoWindow, currentLocation) {
            infoWindow.setPosition(currentLocation);
            infoWindow.setContent(browserHasGeolocation ?
                'Error: The Geolocation service failed.' :
                'Error: Your browser doesn\'t support geolocation.');
            infoWindow.open(samarkand);
        }
    </script>

    <!-- Include the Google Maps JavaScript API with the Places library -->
    <script async="false" type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCCrf73WQ7VitOY7_PP0pSGmeBDw-Tiz38&libraries=places&callback=initMap&map_ids=7802c15fc3df6792" async defer></script>
    <script src="https://cdn.rawgit.com/googlemaps/v3-utility-library/master/markerwithlabel/src/markerwithlabel.js"></script>
</body>
